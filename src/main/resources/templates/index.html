<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Medicamentos por Voz</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    :root {
      --primary-color: #1e40af;        /* Azul principal */
      --secondary-color: #3b82f6;      /* Azul secundario */
      --success-color: #059669;        /* Verde */
      --neutral-color: #6b7280;        /* Gris medio */
      --light-color: #f8fafc;          /* Gris muy claro */
      --dark-color: #1e293b;           /* Gris oscuro */
      --border-color: #e2e8f0;         /* Gris claro para bordes */
      --text-muted: #64748b;           /* Gris para texto secundario */
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', 'Segoe UI', sans-serif;
      background: #f1f5f9;             /* Fondo gris claro s√≥lido */
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: var(--dark-color);
    }

    .voice-container {
      width: 100%;
      max-width: 900px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      position: relative;
      border: 1px solid var(--border-color);
    }

    .header {
      background: var(--primary-color);    /* Azul s√≥lido */
      color: white;
      padding: 30px;
      text-align: center;
      position: relative;
    }

    .header h1 {
      font-size: 2.2rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .header-buttons {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
    }

    .header-btn {
      background: var(--secondary-color);   /* Azul secundario */
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .header-btn:hover {
      background: var(--primary-color);
      transform: translateY(-1px);
    }

    .main-content {
      padding: 40px;
    }

    .status-section {
      text-align: center;
      margin-bottom: 30px;
    }

    .status-text {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--dark-color);
      margin-bottom: 15px;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .system-state {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 500;
      font-size: 1rem;
      border: 2px solid;
    }

    .state-initializing {
      background: var(--light-color);
      color: var(--neutral-color);
      border-color: var(--neutral-color);
    }

    .state-waiting {
      background: #eff6ff;
      color: var(--primary-color);
      border-color: var(--primary-color);
      animation: pulse-state 2s infinite;
    }

    .state-speaking {
      background: #eff6ff;
      color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .state-listening {
      background: #f0fdf4;
      color: var(--success-color);
      border-color: var(--success-color);
      animation: pulse-state 2s infinite;
    }

    .state-processing {
      background: #f8fafc;
      color: var(--neutral-color);
      border-color: var(--neutral-color);
    }

    .state-confirming {
      background: #f0fdf4;
      color: var(--success-color);
      border-color: var(--success-color);
    }

    .state-ready {
      background: #f0fdf4;
      color: var(--success-color);
      border-color: var(--success-color);
    }

    .state-error {
      background: #fef2f2;
      color: #dc2626;
      border-color: #dc2626;
    }

    @keyframes pulse-state {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .transcript-panel {
      background: var(--light-color);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 30px;
      min-height: 180px;
      position: relative;
      max-height: 300px;
      overflow-y: auto;
    }

    .transcript-label {
      position: absolute;
      top: -12px;
      left: 20px;
      background: white;
      padding: 0 12px;
      font-size: 0.85rem;
      color: var(--text-muted);
      font-weight: 500;
    }

    .transcript-content {
      font-size: 1.1rem;
      line-height: 1.6;
      color: var(--dark-color);
      white-space: pre-wrap;
    }

    .transcript-placeholder {
      color: var(--text-muted);
      font-style: italic;
    }

    .system-message {
      color: var(--primary-color);
      font-weight: 500;
      border-left: 4px solid var(--primary-color);
      padding-left: 12px;
      margin: 8px 0;
    }

    .user-message {
      color: var(--dark-color);
      background: #f1f5f9;
      padding: 8px 12px;
      border-radius: 8px;
      margin: 8px 0;
      border-left: 4px solid var(--success-color);
    }

    .controls-section {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .control-btn {
      padding: 14px 28px;
      border: 2px solid;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 140px;
      justify-content: center;
    }

    .control-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .btn-primary:hover {
      background: var(--secondary-color);
      border-color: var(--secondary-color);
    }

    .btn-success {
      background: var(--success-color);
      color: white;
      border-color: var(--success-color);
    }

    .btn-success:hover {
      background: #047857;
      border-color: #047857;
    }

    .btn-danger {
      background: #dc2626;
      color: white;
      border-color: #dc2626;
    }

    .btn-danger:hover {
      background: #b91c1c;
      border-color: #b91c1c;
    }

    .btn-secondary {
      background: var(--neutral-color);
      color: white;
      border-color: var(--neutral-color);
    }

    .btn-secondary:hover {
      background: #4b5563;
      border-color: #4b5563;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }

    .info-card {
      background: white;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .info-card:hover {
      border-color: var(--primary-color);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .info-card-icon {
      font-size: 2rem;
      color: var(--primary-color);
      margin-bottom: 12px;
    }

    .info-card-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--dark-color);
    }

    .info-card-text {
      font-size: 0.9rem;
      color: var(--text-muted);
      line-height: 1.5;
    }

    .notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--success-color);     /* Verde s√≥lido */
      color: white;
      padding: 30px 50px;
      border-radius: 12px;
      font-size: 1.3rem;
      font-weight: 600;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      display: none;
      text-align: center;
      animation: slideIn 0.5s ease-out;
      border: 3px solid #047857;
    }

    .notification.show {
      display: block;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translate(-50%, -60%);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%);
      }
    }

    /* Modal de Ayuda */
    .help-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      padding: 20px;
    }

    .help-modal.show {
      display: flex;
    }

    .help-content {
      background: white;
      border-radius: 12px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      animation: modalSlideIn 0.3s ease-out;
      border: 2px solid var(--border-color);
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .help-header {
      background: var(--primary-color);    /* Azul s√≥lido */
      color: white;
      padding: 25px 30px;
      border-radius: 12px 12px 0 0;
      position: relative;
    }

    .help-header h2 {
      margin: 0;
      font-size: 1.8rem;
      font-weight: 700;
    }

    .help-close {
      position: absolute;
      top: 20px;
      right: 25px;
      background: var(--secondary-color);
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: background 0.3s ease;
    }

    .help-close:hover {
      background: var(--neutral-color);
    }

    .help-body {
      padding: 30px;
    }

    .help-section {
      margin-bottom: 30px;
    }

    .help-section h3 {
      color: var(--primary-color);
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .help-section p {
      color: var(--text-muted);
      line-height: 1.6;
      margin-bottom: 15px;
    }

    .help-list {
      list-style: none;
      padding: 0;
    }

    .help-list li {
      background: var(--light-color);
      padding: 12px 16px;
      margin-bottom: 8px;
      border-radius: 8px;
      border-left: 4px solid var(--primary-color);
    }

    .help-examples {
      background: #eff6ff;
      border: 2px solid var(--secondary-color);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }

    .help-examples h4 {
      color: var(--primary-color);
      margin-bottom: 15px;
      font-size: 1.1rem;
    }

    .example-phrase {
      background: white;
      padding: 10px 15px;
      margin: 8px 0;
      border-radius: 8px;
      border-left: 3px solid var(--success-color);
      font-style: italic;
      color: var(--dark-color);
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 768px) {
      .voice-container {
        border-radius: 12px;
      }

      .header h1 {
        font-size: 1.8rem;
      }

      .main-content {
        padding: 24px;
      }

      .status-text {
        font-size: 1.2rem;
      }

      .control-btn {
        font-size: 1rem;
        padding: 12px 24px;
        min-width: 120px;
      }

      .help-content {
        margin: 10px;
        max-height: 95vh;
      }

      .help-body {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
<div class="voice-container">
  <div class="header">
    <h1><i class="bi bi-mic-fill"></i> Sistema de Medicamentos por Voz</h1>
    <p>Asistente inteligente para personas con discapacidad visual</p>
    <div class="header-buttons">
      <button class="header-btn" onclick="showHelp()">
        <i class="bi bi-question-circle-fill"></i> Ayuda
      </button>
      <button class="header-btn" onclick="accessAdmin()">
        <i class="bi bi-gear-fill"></i> Admin
      </button>
    </div>
  </div>

  <div class="main-content">
    <div class="status-section">
      <div class="status-text" id="statusText">
        Sistema preparado - Hable para comenzar
      </div>
      <div class="system-state state-waiting" id="systemState">
        <i class="bi bi-mic"></i>
        <span>Esperando voz</span>
      </div>
    </div>

    <div class="transcript-panel">
      <div class="transcript-label">Conversaci√≥n</div>
      <div class="transcript-content" id="transcriptContent">
        <div class="transcript-placeholder">
          Hable cualquier palabra para activar el sistema...
        </div>
      </div>
    </div>

    <div class="controls-section">
      <button id="startBtn" class="control-btn btn-primary hidden">
        <i class="bi bi-play-circle-fill"></i>
        Iniciar
      </button>

      <button id="restartBtn" class="control-btn btn-secondary hidden">
        <i class="bi bi-arrow-clockwise"></i>
        Reiniciar
      </button>

      <button id="confirmYesBtn" class="control-btn btn-success hidden">
        <i class="bi bi-check-circle-fill"></i>
        S√≠, Confirmar
      </button>

      <button id="confirmNoBtn" class="control-btn btn-danger hidden">
        <i class="bi bi-x-circle-fill"></i>
        No, Cancelar
      </button>
    </div>

    <div class="info-grid">
      <div class="info-card">
        <div class="info-card-icon">
          <i class="bi bi-1-circle-fill"></i>
        </div>
        <div class="info-card-title">Hable para Activar</div>
        <div class="info-card-text">
          Diga cualquier palabra para activar el sistema autom√°ticamente
        </div>
      </div>

      <div class="info-card">
        <div class="info-card-icon">
          <i class="bi bi-2-circle-fill"></i>
        </div>
        <div class="info-card-title">Escuche las Instrucciones</div>
        <div class="info-card-text">
          El sistema le dar√° indicaciones claras y concisas por voz
        </div>
      </div>

      <div class="info-card">
        <div class="info-card-icon">
          <i class="bi bi-3-circle-fill"></i>
        </div>
        <div class="info-card-title">Solicite su Medicamento</div>
        <div class="info-card-text">
          Diga frases como "Necesito paracetamol" o "Quiero ibuprofeno"
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Ayuda -->
<div class="help-modal" id="helpModal">
  <div class="help-content">
    <div class="help-header">
      <h2><i class="bi bi-info-circle-fill"></i> Gu√≠a de Uso del Sistema</h2>
      <button class="help-close" onclick="hideHelp()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="help-body">
      <div class="help-section">
        <h3><i class="bi bi-play-circle"></i> Activaci√≥n por Voz</h3>
        <p>El sistema se activa autom√°ticamente cuando detecta cualquier sonido de voz. No necesita decir nada espec√≠fico, solo hable.</p>
        <ul class="help-list">
          <li><strong>Activaci√≥n Autom√°tica:</strong> Hable cualquier palabra para comenzar</li>
          <li><strong>Instrucciones Claras:</strong> El sistema le dar√° indicaciones precisas</li>
          <li><strong>Proceso Guiado:</strong> Cada paso ser√° explicado claramente</li>
          <li><strong>Sin Botones:</strong> Todo funciona completamente por voz</li>
        </ul>
      </div>

      <div class="help-section">
        <h3><i class="bi bi-mic"></i> C√≥mo Solicitar Medicamentos</h3>
        <p>Una vez activado, puede solicitar medicamentos usando frases naturales. El sistema extraer√° autom√°ticamente el nombre del medicamento.</p>

        <div class="help-examples">
          <h4>Ejemplos de frases que puede usar:</h4>
          <div class="example-phrase">"Necesito paracetamol"</div>
          <div class="example-phrase">"Quiero ibuprofeno"</div>
          <div class="example-phrase">"Busco aspirina"</div>
          <div class="example-phrase">"Dame omeprazol"</div>
          <div class="example-phrase">"Solicito amoxicilina"</div>
          <div class="example-phrase">"Requiero loratadina"</div>
        </div>
      </div>

      <div class="help-section">
        <h3><i class="bi bi-check-circle"></i> Proceso de Confirmaci√≥n</h3>
        <p>El sistema confirmar√° su solicitud antes de proceder con la impresi√≥n.</p>
        <ul class="help-list">
          <li><strong>Para Confirmar:</strong> Diga "S√≠", "Afirmativo", "Correcto" o "Confirmo"</li>
          <li><strong>Para Cancelar:</strong> Diga "No", "Cancelar", "Negativo" o "Incorrecto"</li>
          <li><strong>Nueva Consulta:</strong> Despu√©s de cada operaci√≥n, puede hacer una nueva solicitud</li>
        </ul>
      </div>

      <div class="help-section">
        <h3><i class="bi bi-exclamation-triangle"></i> Qu√© Hacer Si...</h3>
        <ul class="help-list">
          <li><strong>No se activa:</strong> Hable m√°s fuerte o ac√©rquese al micr√≥fono</li>
          <li><strong>No encuentra el medicamento:</strong> Intente con otro nombre o pronunciaci√≥n</li>
          <li><strong>No est√° disponible:</strong> El sistema le informar√° sobre la falta de stock</li>
          <li><strong>Error de reconocimiento:</strong> El sistema le pedir√° que repita</li>
        </ul>
      </div>

      <div class="help-section">
        <h3><i class="bi bi-headphones"></i> Requisitos T√©cnicos</h3>
        <ul class="help-list">
          <li><strong>Navegador:</strong> Chrome, Edge o Safari (recomendado)</li>
          <li><strong>Micr√≥fono:</strong> Debe permitir el acceso al micr√≥fono</li>
          <li><strong>Audio:</strong> Aseg√∫rese de que el volumen est√© activado</li>
          <li><strong>Internet:</strong> Conexi√≥n estable para consultar la base de datos</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<div class="notification" id="printNotification">
  <i class="bi bi-printer-fill"></i><br>
  ¬°Medicamento Impreso Exitosamente!
</div>

<script>
  class VoiceMedicineSystem {
    constructor() {
      this.recognition = null;
      this.synthesis = window.speechSynthesis;
      this.currentState = 'waiting'; // Estado inicial: esperando voz
      this.isSystemSpeaking = false;
      this.currentMedicine = null;
      this.currentRequestId = null;
      this.currentQuery = '';
      this.browserType = this.detectBrowser();
      this.isActivated = false; // Sistema no activado hasta detectar voz

      // DOM Elements
      this.statusText = document.getElementById('statusText');
      this.systemState = document.getElementById('systemState');
      this.transcriptContent = document.getElementById('transcriptContent');
      this.startBtn = document.getElementById('startBtn');
      this.restartBtn = document.getElementById('restartBtn');
      this.confirmYesBtn = document.getElementById('confirmYesBtn');
      this.confirmNoBtn = document.getElementById('confirmNoBtn');
      this.printNotification = document.getElementById('printNotification');

      this.setupEventListeners();
      this.initializeSystem();
    }

    detectBrowser() {
      const userAgent = navigator.userAgent.toLowerCase();
      if (userAgent.includes('chrome') && !userAgent.includes('edge')) {
        return 'chrome';
      } else if (userAgent.includes('edge')) {
        return 'edge';
      } else if (userAgent.includes('firefox')) {
        return 'firefox';
      } else if (userAgent.includes('safari')) {
        return 'safari';
      }
      return 'unknown';
    }

    async initializeSystem() {
      this.log('Sistema detectado: ' + this.browserType, 'system');
      this.log('Sistema preparado. Esperando activaci√≥n por voz...', 'system');

      if (!this.checkBrowserSupport()) {
        this.log('Error: Su navegador no soporta las funciones de voz necesarias.', 'error');
        return;
      }

      try {
        // Configurar reconocimiento de voz
        await this.setupSpeechRecognition();

        // Preparar s√≠ntesis de voz
        await this.prepareSpeechSynthesis();

        // Comenzar a escuchar para activaci√≥n
        this.startWaitingForActivation();

      } catch (error) {
        console.error('Error al inicializar sistema:', error);
        this.log('Error al inicializar el sistema: ' + error.message, 'error');
      }
    }

    async prepareSpeechSynthesis() {
      return new Promise((resolve) => {
        const loadVoices = () => {
          const voices = this.synthesis.getVoices();
          console.log('Voces disponibles:', voices.length);
          resolve();
        };

        if (this.synthesis.getVoices().length > 0) {
          loadVoices();
        } else {
          this.synthesis.onvoiceschanged = loadVoices;
          setTimeout(() => resolve(), 2000);
        }
      });
    }

    checkBrowserSupport() {
      const hasRecognition = 'SpeechRecognition' in window || 'webkitSpeechRecognition' in window;
      const hasSynthesis = 'speechSynthesis' in window;

      if (!hasRecognition || !hasSynthesis) {
        this.updateState('error', 'Navegador no compatible');
        this.statusText.textContent = 'Por favor, use Chrome, Edge o Safari para acceder a todas las funciones.';
        return false;
      }
      return true;
    }

    async setupSpeechRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      this.recognition = new SpeechRecognition();

      // Configuraci√≥n espec√≠fica por navegador
      if (this.browserType === 'edge') {
        this.recognition.lang = 'es-ES';
        this.recognition.continuous = false;
        this.recognition.interimResults = false;
        this.recognition.maxAlternatives = 3;
      } else {
        this.recognition.lang = 'es-ES';
        this.recognition.continuous = false;
        this.recognition.interimResults = false;
        this.recognition.maxAlternatives = 1;
      }

      this.recognition.onstart = () => {
        console.log('üé§ Reconocimiento iniciado');
        if (this.currentState === 'waiting') {
          this.updateState('waiting', 'Esperando que hable...');
        } else if (!this.isSystemSpeaking) {
          this.updateState('listening', 'Escuchando...');
        }
      };

      this.recognition.onresult = (event) => {
        let transcript = '';

        // Para Edge, probar m√∫ltiples alternativas
        if (this.browserType === 'edge' && event.results[0].length > 1) {
          for (let i = 0; i < event.results[0].length; i++) {
            const alternative = event.results[0][i].transcript.trim();
            console.log(`üìù Alternativa ${i + 1}:`, alternative);
            if (i === 0) transcript = alternative;
          }
        } else {
          transcript = event.results[0][0].transcript.trim();
        }

        console.log('üìù Texto final reconocido:', transcript);
        this.handleUserInput(transcript);
      };

      this.recognition.onerror = (event) => {
        console.error('‚ùå Error de reconocimiento:', event.error);
        this.handleRecognitionError(event.error);
      };

      this.recognition.onend = () => {
        console.log('üîá Reconocimiento terminado');
        if (this.currentState === 'waiting' && !this.isActivated) {
          // Si estamos esperando activaci√≥n, reiniciar escucha
          setTimeout(() => this.startWaitingForActivation(), 1000);
        } else if (this.currentState === 'listening' || this.currentState === 'confirming') {
          this.updateState('processing', 'Procesando...');
        }
      };
    }

    startWaitingForActivation() {
      if (!this.isActivated && this.recognition) {
        try {
          this.currentState = 'waiting';
          this.updateState('waiting', 'Hable para activar el sistema');
          this.recognition.start();
        } catch (error) {
          console.error('Error al iniciar escucha de activaci√≥n:', error);
          setTimeout(() => this.startWaitingForActivation(), 2000);
        }
      }
    }

    setupEventListeners() {
      this.startBtn.addEventListener('click', () => this.startSystem());
      this.restartBtn.addEventListener('click', () => this.restartSystem());
      this.confirmYesBtn.addEventListener('click', () => this.confirmPrint());
      this.confirmNoBtn.addEventListener('click', () => this.cancelPrint());

      // Escuchar eventos de teclado para accesibilidad
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' && this.currentState === 'confirming') {
          this.confirmPrint();
        } else if (event.key === 'Escape') {
          if (this.currentState === 'confirming') {
            this.cancelPrint();
          } else {
            this.restartSystem();
          }
        }
      });
    }

    handleUserInput(transcript) {
      if (this.currentState === 'waiting' && !this.isActivated) {
        // Primera voz detectada - activar sistema
        this.activateSystem(transcript);
      } else if (this.currentState === 'listening') {
        // Procesar solicitud de medicamento
        this.currentQuery = transcript;
        this.log(`Usuario: "${transcript}"`, 'user');
        this.updateState('processing', 'Procesando consulta...');
        this.processMedicineRequest(transcript);
      } else if (this.currentState === 'confirming') {
        // Procesar confirmaci√≥n
        this.log(`Usuario: "${transcript}"`, 'user');
        this.processConfirmation(transcript);
      }
    }

    activateSystem(firstInput) {
      this.isActivated = true;
      this.log(`Voz detectada: "${firstInput}" - Activando sistema`, 'system');
      this.updateState('speaking', 'Sistema activado - Iniciando...');

      // Mensaje de bienvenida claro y conciso
      const welcomeMessage = `Sistema activado. Bienvenido al asistente de medicamentos por voz.
                                       D√≠game qu√© medicamento necesita.
                                       Por ejemplo: "Necesito paracetamol" o "Quiero ibuprofeno".`;

      this.speak(welcomeMessage, () => {
        this.currentState = 'listening';
        this.startListening();
      });
    }

    startSystem() {
      if (!this.isActivated) {
        this.activateSystem('inicio manual');
        return;
      }

      this.currentState = 'starting';
      this.updateState('speaking', 'Sistema hablando...');
      this.showControls(['restart']);

      const welcomeMessage = `D√≠game qu√© medicamento necesita.`;

      this.speak(welcomeMessage, () => {
        this.currentState = 'listening';
        this.startListening();
      });
    }

    restartSystem() {
      this.currentState = 'restarting';
      this.currentMedicine = null;
      this.currentRequestId = null;
      this.currentQuery = '';

      this.speak('Reiniciando. D√≠game qu√© medicamento necesita.', () => {
        this.currentState = 'listening';
        this.startListening();
      });
    }

    speak(text, callback) {
      this.isSystemSpeaking = true;
      this.updateState('speaking', 'Sistema hablando...');
      this.log(`Sistema: "${text}"`, 'system');

      if (this.synthesis.speaking) {
        this.synthesis.cancel();
      }

      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'es-ES';

      // Configuraci√≥n espec√≠fica por navegador
      if (this.browserType === 'edge') {
        utterance.rate = 0.8;
        utterance.pitch = 1.1;
        utterance.volume = 0.9;
      } else if (this.browserType === 'chrome') {
        utterance.rate = 0.85;
        utterance.pitch = 1;
        utterance.volume = 1;
      } else {
        utterance.rate = 0.85;
        utterance.pitch = 1;
        utterance.volume = 1;
      }

      // Buscar voz en espa√±ol si est√° disponible
      const voices = this.synthesis.getVoices();
      const spanishVoice = voices.find(voice =>
              voice.lang.startsWith('es') || voice.lang.includes('ES')
      );

      if (spanishVoice) {
        utterance.voice = spanishVoice;
      }

      utterance.onend = () => {
        this.isSystemSpeaking = false;
        if (callback) {
          setTimeout(callback, 500);
        }
      };

      utterance.onerror = (event) => {
        console.error('Error en s√≠ntesis de voz:', event);
        this.isSystemSpeaking = false;
        if (callback) callback();
      };

      this.synthesis.speak(utterance);
    }

    startListening() {
      if (this.recognition && !this.isSystemSpeaking) {
        try {
          this.updateState('listening', 'Escuchando...');
          this.recognition.start();
        } catch (error) {
          console.error('Error al iniciar reconocimiento:', error);
          setTimeout(() => this.startListening(), 1000);
        }
      }
    }

    processMedicineRequest(query) {
      const medicine = this.extractMedicineFromQuery(query);

      if (!medicine) {
        this.speak(`No identifiqu√© el medicamento. Intente de nuevo diciendo "Necesito" seguido del nombre del medicamento.`,
                () => this.startListening());
        return;
      }

      this.searchMedicineInDatabase(medicine, query);
    }

    extractMedicineFromQuery(query) {
      const cleanQuery = query.toLowerCase().trim();

      // Normalizar caracteres especiales para Edge
      const normalizedQuery = cleanQuery
              .normalize('NFD')
              .replace(/[\u0300-\u036f]/g, '') // Remover acentos
              .replace(/[^\w\s]/g, ' ') // Remover puntuaci√≥n
              .replace(/\s+/g, ' ') // Normalizar espacios
              .trim();

      console.log('üîç Query original:', query);
      console.log('üîç Query normalizada:', normalizedQuery);

      const indicators = ['necesito', 'quiero', 'busco', 'dame', 'deme', 'solicito', 'requiero', 'me das', 'me da', 'quisiera'];

      let medicine = normalizedQuery;

      // Remover indicadores
      for (const indicator of indicators) {
        if (medicine.includes(indicator)) {
          medicine = medicine.replace(new RegExp(`\\b${indicator}\\b`, 'g'), '').trim();
          break;
        }
      }

      // Remover palabras comunes
      const commonWords = ['el', 'la', 'un', 'una', 'de', 'para', 'por favor', 'por', 'favor'];
      for (const word of commonWords) {
        medicine = medicine.replace(new RegExp(`\\b${word}\\b`, 'g'), '').trim();
      }

      const finalMedicine = medicine.replace(/\s+/g, ' ').trim();
      console.log('üíä Medicamento extra√≠do:', finalMedicine);

      return finalMedicine;
    }

    async searchMedicineInDatabase(medicine, originalQuery) {
      try {
        this.updateState('processing', 'Buscando en base de datos...');

        console.log('üîç Buscando medicamento:', medicine);

        const response = await fetch('/voz/procesar', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ texto: medicine })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        console.log('üìä Respuesta del servidor:', data);

        if (data.encontrado) {
          this.currentMedicine = data.medicamento;
          this.currentRequestId = data.solicitudId;

          if (data.disponible) {
            this.confirmMedicineFound(originalQuery);
          } else {
            this.handleMedicineNotAvailable();
          }
        } else {
          this.handleMedicineNotFound(medicine);
        }
      } catch (error) {
        console.error('‚ùå Error en b√∫squeda:', error);
        this.speak(`Error al buscar el medicamento. Intente de nuevo.`,
                () => this.startListening());
      }
    }

    confirmMedicineFound(originalQuery) {
      this.currentState = 'confirming';
      this.updateState('confirming', 'Esperando confirmaci√≥n...');
      this.showControls(['restart', 'confirmYes', 'confirmNo']);

      const confirmMessage = `Encontr√© ${this.currentMedicine} y est√° disponible.
                                       ¬øConfirma la impresi√≥n? Responda "S√≠" o "No".`;

      this.speak(confirmMessage, () => this.startListening());
    }

    handleMedicineNotAvailable() {
      this.speak(`${this.currentMedicine} no est√° disponible. Intente con otro medicamento.`,
              () => {
                this.currentState = 'listening';
                this.startListening();
              });
    }

    handleMedicineNotFound(medicine) {
      this.speak(`No encontr√© "${medicine}". Verifique el nombre e intente de nuevo.`,
              () => this.startListening());
    }

    processConfirmation(response) {
      const cleanResponse = response.toLowerCase().trim();

      if (this.isPositiveResponse(cleanResponse)) {
        this.confirmPrint();
      } else if (this.isNegativeResponse(cleanResponse)) {
        this.cancelPrint();
      } else {
        this.speak('Responda "S√≠" para confirmar o "No" para cancelar.',
                () => this.startListening());
      }
    }

    isPositiveResponse(response) {
      const positiveWords = ['s√≠', 'si', 'yes', 'afirmativo', 'correcto', 'exacto', 'confirmo', 'acepto'];
      return positiveWords.some(word => response.includes(word));
    }

    isNegativeResponse(response) {
      const negativeWords = ['no', 'negativo', 'incorrecto', 'cancelar', 'rechazar'];
      return negativeWords.some(word => response.includes(word));
    }

    async confirmPrint() {
      try {
        this.updateState('processing', 'Procesando impresi√≥n...');
        this.showControls(['restart']);

        const response = await fetch('/voz/confirmar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ solicitudId: this.currentRequestId })
        });

        const data = await response.json();

        if (data.success) {
          this.showPrintNotification();
          this.speak(`${this.currentMedicine} impreso correctamente. ¬øNecesita otro medicamento?`,
                  () => this.resetForNewQuery());
        } else {
          this.speak('Error en la impresi√≥n. Contacte al personal.',
                  () => this.resetForNewQuery());
        }
      } catch (error) {
        console.error('Error en impresi√≥n:', error);
        this.speak('Error de conexi√≥n. Contacte al personal.',
                () => this.resetForNewQuery());
      }
    }

    cancelPrint() {
      this.speak(`Impresi√≥n cancelada. ¬øNecesita otro medicamento?`,
              () => this.resetForNewQuery());
    }

    resetForNewQuery() {
      this.currentState = 'listening';
      this.currentMedicine = null;
      this.currentRequestId = null;
      this.currentQuery = '';
      this.showControls(['restart']);
      this.updateState('listening', 'Listo para nueva consulta');

      setTimeout(() => this.startListening(), 1000);
    }

    handleRecognitionError(error) {
      let errorMessage = '';

      switch (error) {
        case 'no-speech':
          if (this.currentState === 'waiting') {
            // No hacer nada, seguir esperando
            return;
          }
          errorMessage = 'No detect√© voz. Intente de nuevo.';
          break;
        case 'audio-capture':
          errorMessage = 'Error de micr√≥fono. Verifique la conexi√≥n.';
          break;
        case 'not-allowed':
          errorMessage = 'Permiso de micr√≥fono denegado. Permita el acceso y recargue.';
          break;
        case 'network':
          errorMessage = 'Error de conexi√≥n. Verifique internet.';
          break;
        default:
          errorMessage = 'Error de reconocimiento. Intente de nuevo.';
      }

      console.error('üö® Error de reconocimiento:', error);
      this.log(errorMessage, 'error');

      if (this.currentState === 'waiting') {
        // Si estamos esperando activaci√≥n, reiniciar escucha
        setTimeout(() => this.startWaitingForActivation(), 2000);
      } else {
        this.speak(errorMessage, () => {
          if (this.currentState === 'listening' || this.currentState === 'confirming') {
            setTimeout(() => this.startListening(), 2000);
          }
        });
      }
    }

    showPrintNotification() {
      this.printNotification.classList.add('show');
      setTimeout(() => {
        this.printNotification.classList.remove('show');
      }, 4000);
    }

    showControls(controls) {
      const allControls = ['start', 'restart', 'confirmYes', 'confirmNo'];

      allControls.forEach(control => {
        const element = document.getElementById(control + 'Btn');
        if (controls.includes(control)) {
          element.classList.remove('hidden');
        } else {
          element.classList.add('hidden');
        }
      });
    }

    updateState(state, message) {
      this.statusText.textContent = message;

      const stateElement = this.systemState;
      stateElement.className = `system-state state-${state}`;

      const stateIcons = {
        waiting: 'bi-mic',
        initializing: 'bi-hourglass-split',
        ready: 'bi-check-circle-fill',
        speaking: 'bi-volume-up-fill',
        listening: 'bi-mic-fill',
        processing: 'bi-gear-fill',
        confirming: 'bi-question-circle-fill',
        error: 'bi-exclamation-triangle-fill'
      };

      const stateTexts = {
        waiting: 'Esperando',
        initializing: 'Preparando',
        ready: 'Listo',
        speaking: 'Hablando',
        listening: 'Escuchando',
        processing: 'Procesando',
        confirming: 'Confirmando',
        error: 'Error'
      };

      stateElement.innerHTML = `
                    <i class="bi ${stateIcons[state] || 'bi-circle'}"></i>
                    <span>${stateTexts[state] || 'Estado'}</span>
                `;
    }

    log(message, type = 'system') {
      const timestamp = new Date().toLocaleTimeString();
      const messageElement = document.createElement('div');

      if (type === 'system') {
        messageElement.className = 'system-message';
        messageElement.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
      } else if (type === 'user') {
        messageElement.className = 'user-message';
        messageElement.innerHTML = `<strong>[${timestamp}] Usuario:</strong> ${message}`;
      } else {
        messageElement.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
      }

      this.transcriptContent.appendChild(messageElement);
      this.transcriptContent.scrollTop = this.transcriptContent.scrollHeight;

      // Limpiar mensajes antiguos (mantener √∫ltimos 15)
      const messages = this.transcriptContent.children;
      if (messages.length > 15) {
        this.transcriptContent.removeChild(messages[0]);
      }
    }
  }

  // Funciones para el modal de ayuda
  function showHelp() {
    document.getElementById('helpModal').classList.add('show');
  }

  function hideHelp() {
    document.getElementById('helpModal').classList.remove('show');
  }

  // Cerrar modal al hacer clic fuera
  document.getElementById('helpModal').addEventListener('click', function(e) {
    if (e.target === this) {
      hideHelp();
    }
  });

  // Funci√≥n para acceso administrativo
  function accessAdmin() {
    const password = prompt("Ingrese la clave de acceso:");
    if (password === "admin123") {
      window.location.href = "/admin/dashboard";
    } else if (password !== null) {
      alert("Clave incorrecta");
    }
  }

  // Inicializar el sistema cuando la p√°gina est√© lista
  let voiceSystem;
  document.addEventListener('DOMContentLoaded', () => {
    voiceSystem = new VoiceMedicineSystem();
  });

  // Solicitar permisos de micr√≥fono autom√°ticamente
  navigator.mediaDevices.getUserMedia({ audio: true })
          .then(stream => {
            console.log('‚úÖ Permisos de micr√≥fono concedidos');
            stream.getTracks().forEach(track => track.stop());
          })
          .catch(error => {
            console.warn('‚ö†Ô∏è Permisos de micr√≥fono no concedidos:', error);
          });
</script>
</body>
</html>